<body>
  <script type="importmap">
    {
      "imports": {
        "three": "../../../node_modules/three/build/three.module.js",
        "three/examples/": "../../../node_modules/three/examples/",

        "@monogrid/gainmap-js/encode": "../../../dist/encode.js"
      }
    }
  </script>
  <script type="module">
    import { encodeAndCompress, findTextureMinMax } from '@monogrid/gainmap-js/encode';
    import { ACESFilmicToneMapping } from 'three'
    import { EXRLoader } from 'three/examples/jsm/loaders/EXRLoader.js'
    import { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader.js'

    window.encodeAndCompress = async (url, mimeType = 'image/jpeg', quality = 0.9, toneMapping = ACESFilmicToneMapping) => {
      let loader
      if (url.indexOf('.exr') !== -1) loader = new EXRLoader()
      if (url.indexOf('.hdr') !== -1) loader = new RGBELoader()
      const image = await loader.loadAsync(`https://local/${url}`)
      image.flipY = false

      const textureMax = findTextureMinMax(image)

      const result = await encodeAndCompress({
        image,
        mimeType,
        quality,
        flipY: loader instanceof EXRLoader,
        maxContentBoost: Math.max.apply(this, textureMax),
        toneMapping
      })
      // Uint8Arrays can't be transferred outside puppeteer
      result.gainMap.data = Array.from(result.gainMap.data)
      result.sdr.data = Array.from(result.sdr.data)

      return {
        ...result,
        textureMax
      }
    }

  </script>
</body>
