<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>

<body>
  <script type="importmap">
    {
      "imports": {
        "three": "../../../node_modules/three/build/three.module.js",
        "three/examples/": "../../../node_modules/three/examples/",

        "@monogrid/gainmap-js": "../../../dist/decode.js",
        "@monogrid/gainmap-js/encode": "../../../dist/encode.js",
        "@monogrid/gainmap-js/libultrahdr": "../../../dist/libultrahdr.js"
      }
    }
  </script>
  <script type="module">
    import { encodeAndCompress, findTextureMinMax } from '@monogrid/gainmap-js/encode';
    import { encodeJPEGMetadata, decodeJPEGMetadata } from '@monogrid/gainmap-js/libultrahdr';
    import { ACESFilmicToneMapping } from 'three'
    import { EXRLoader } from 'three/examples/jsm/loaders/EXRLoader.js'
    import { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader.js'

    const getArrayBuffer = (file) => {
      return new Promise((resolve, reject) => {
        var fr = new FileReader();
        fr.onload = () => {
          resolve(fr.result);
        }
        fr.readAsArrayBuffer(file);
      })
    }

    window.encodeAndCompress = async (url, mimeType = 'image/jpeg', quality = 0.9, toneMapping = ACESFilmicToneMapping) => {
      let loader
      if (url.indexOf('.exr') !== -1) loader = new EXRLoader()
      if (url.indexOf('.hdr') !== -1) loader = new RGBELoader()
      const image = await loader.loadAsync(`https://local/${url}`)
      image.flipY = false

      const textureMax = findTextureMinMax(image)

      const result = await encodeAndCompress({
        image,
        mimeType,
        quality,
        flipY: loader instanceof EXRLoader,
        maxContentBoost: Math.max.apply(this, textureMax),
        toneMapping
      })
      // Uint8Arrays can't be transferred outside puppeteer
      result.gainMap.data = Array.from(result.gainMap.data)
      result.sdr.data = Array.from(result.sdr.data)

      return {
        ...result,
        textureMax
      }
    }

    window.encodeJPEGMetadata = async (url, quality = 0.9, toneMapping = ACESFilmicToneMapping) => {
      let loader
      if (url.indexOf('.exr') !== -1) loader = new EXRLoader()
      if (url.indexOf('.hdr') !== -1) loader = new RGBELoader()
      const image = await loader.loadAsync(`https://local/${url}`)
      image.flipY = false

      const textureMax = findTextureMinMax(image)

      const result = await encodeAndCompress({
        image,
        mimeType: 'image/jpeg',
        quality,
        flipY: loader instanceof EXRLoader,
        maxContentBoost: Math.max.apply(this, textureMax),
        toneMapping
      })

      const jpeg = await encodeJPEGMetadata(result)
      // Uint8Arrays can't be transferred outside puppeteer
      return Array.from(jpeg)
    }
    window.decodeJPEGMetadata = async (url) => {
      const response = await fetch(`https://local/${url}`)
      const buf = await response.arrayBuffer()
      const result = await decodeJPEGMetadata(new Uint8Array(buf))

      // Uint8Arrays can't be transferred outside puppeteer
      result.gainMap = Array.from(result.gainMap)
      result.sdr = Array.from(result.sdr)
      return result
    }

    document.getElementById('hdr').onchange = async (e) => {
      const file = e.target.files[0]
      const buf = new Uint8Array(await getArrayBuffer(file))

      let loader
      if (file.name.indexOf('.exr') !== -1) loader = new EXRLoader()
      if (file.name.indexOf('.hdr') !== -1) loader = new RGBELoader()
      const image = await loader.parse(buf.buffer)
      const textureMax = findTextureMinMax(image)
      const result = await encodeAndCompress({
        image,
        mimeType: 'image/jpeg',
        flipY: loader instanceof EXRLoader,
        maxContentBoost: Math.max.apply(this, textureMax)
      })

      encodeJPEGMetadata(result)
    }

    document.getElementById('gainmap').onchange = async (e) => {
      const file = e.target.files[0]
      const buf = new Uint8Array(await getArrayBuffer(file))
      const result = await decodeJPEGMetadata(buf)

      console.log(result)
    }

  </script>
  <div>
    HDR: <input type="file" id="hdr" />
  </div>
  <div>
    GAINMAP: <input type="file" id="gainmap" />
  </div>
</body>

</html>
